# Prometheus
![](https://upload.wikimedia.org/wikipedia/commons/thumb/3/38/Prometheus_software_logo.svg/1200px-Prometheus_software_logo.svg.png)
## Что такое Prometheus
Мониторинг в ИТ сегодня – это система, которая позволяет в режиме реального времени выявлять проблемы в ИТ инфраструктуре, а также оценивать тренды использования ресурсов. Как правило состоит из нескольких базовых компонентов – сбора сырых данных, обработки данных с целью их анализа, рассылки уведомлений и пользовательского интерфейса для просмотра графиков и отчетов. В настоящее время существует большое количество систем для мониторинга различных категорий – сети, серверной инфраструктуры, производительности приложений (APM), реального пользователя (RUM), безопасности и др. Таким образом, мониторить можно все – от сетевой доступности узлов в огромной корпорации до значений датчика температуры в спальне в «умном» доме.

Ядро – БД временных рядов (Time series database, TSDB). Поддерживает сбор данных из различных источников посредством экспортеров и шлюза PushGateway. Имеются инструменты для анализа данных, подсистема уведомлений и простой веб-интерфейс. Для визуализации рекомендуется использовать Grafana.

Написан на языке программирования `Go`.

Prometheus - Это бесплатная система мониторинга и оповещения

Prometheus - Собирает и хранит метрики в виде данных Time Series в
TSDB (Time Series DataBase), то есть информация о метриках
сохраняется с отметкой времени,в которой она была записана.

### Monitoring
Monitoring - это информация о части системы в определенное время
- CPU Utilization
- Disk Space
- Количество файлов в директории /my files
- Количество ошибок http 404 за последние 5 минут
- Количество запросов http GET за последние 5 минут

Для чего нужен Monitoring?
- Нужен для помощи в Debugging
- Можно видеть состояние системы до, во время, после проблемы
- Нужен чтобы видеть тренд проблемы и приближающиеся проблемы
- Нужен для автоматизации
- Нужен для того чтобы было что делать когда делать нечего

## Как выглядит простая рализация
![](https://habrastorage.org/getpro/habr/upload_files/5e1/96a/e93/5e196ae934aec8a537e57e8aef97c1fa.png)

## Работа с Prometheus и Grafana

Рассмотрим подробнее схему взаимодействия компонентов системы мониторинга на основе Prometheus. Базовая конфигурация состоит из 4ех компонентов экосистемы:

### Экспортеры (exporters)
Экспортер собирает данные и возвращает их в виде набора метрик. Экспортеры делятся на официальные (написанные командой Prometheus) и неофициальные (написанные разработчиками различного программного обеспечения для интеграции с Prometheus). При необходимости есть возможность писать свои экспортеры и расширять существующие дополнительными метриками

### Prometheus
Получает метрики от экспортеров и сохраняет их в БД временных рядов. Поддерживает мощный язык запросов PromQL (Prometheus Query Language) для выборки и аггрегации метрик. Позволяет строить простые  графики и формировать правила уведомлений (alerts) на основе выражений PromQL для отправки через Alertmanager

### Alertmanager
Обрабатывает уведомления от Prometheus и рассылает их. С помощью механизма приемников (receivers) реализована интеграция с почтой (SMTP), Telegram, Slack и др. системами, а также отправка сообщений в собственный API посредством вебхуков (webhook)

### Grafana
Предоставляет средства визуализации и дополнительного анализа информации из Prometheus и VictoriaMetrics. Есть примеры дашбордов практически под любые задачи, которые при необходимости можно легко  доработать. Создание собственных дашбордов также интуитивно (разумеется, за исключением некоторых тонкостей) – достаточно знать основы PromQL / MetricsQL

### Фан факт
Де-факто использование Grafana вместе с Prometheus уже стало стандартом, в то время как добавление в конфигурацию VictoriaMetrics безусловно опционально и необходимо скорее для высоконагруженных систем.

## Основные экспортеры  
1. <details open><summary>cadvisor</summary>cAdvisor (Container Advisor) предоставляет данные по использованию ресурсов и производительности запущенных контейнеров. Формирует метрики в читаемом для Prometheus формате. Наряду с node_exporter является одним из самых необходимых экспортеров.</details>
2. <details open><summary>node</summary>Официальный экспортер. Формирует метрики по аппаратному обеспечению и ОС. Для Windows машин рекомендуется использовать prometheus/windows_exporter (2014 stars). Альфа и омега вашей системы мониторинга, имеет смысл ставить практически всегда. Развертывание в виде контейнера не рекомендуется, однако возможно</details>
3. <details open><summary>blackbox</summary>Официальный экспортер. Формирует метрики по доступности точек входа по HTTP/HTTPS, TCP, ICMP и др. Простой, но в то же время один из самых эффективных экспортеров, который пригодится в любой инсталляции.</details>
4. <details open><summary>jmx</summary>Официальный экспортер. Java Management Extensions (JMX) – технология Java, которая предоставляет в числе прочего инструменты для мониторинга приложений. JMX экспортер формирует метрики Java приложений. Может быть запущен как Java Agent (рекомендуемый метод) или отдельно стоящий сервер, который удаленно будет опрашивать JMX цели.</details>
5. <details open><summary>redis</summary>Экспортер от oliver006. Формирует достаточный для анализа набор метрик по Redis.</details>

## Metrics types
### Counter (Счётчик)
Описание:
Счётчик представляет собой монотонно увеличивающуюся метрику, которая отслеживает количество событий или операций. Значение счётчика может только увеличиваться (или сбрасываться на 0 при рестарте приложения).

Примеры использования:

- Количество запросов к серверу (http_requests_total).
- Количество ошибок (errors_total).
- Количество завершённых задач.
```PromQL 
http_requests_total{method="GET", status="200"} 1523 
```