# Terraform
![](https://miro.medium.com/v2/resize:fit:400/1*lG-hTnKrmpQO306772jGpg.png)
## Theory
### Что такое terraform 
`Terraform` — это мощный программный инструмент Infrastructure as Code (IaC), предлагаемый `HashiCorp`. Он облегчает подготовку и управление вашей инфраструктурой локально и в облаке. Его можно легко расширить с помощью архитектуры на основе плагинов.
### Как он работает
На высоком уровне `Terraform` можно рассматривать как состоящий из двух основных частей : `Terraform Core` и `Plugins`. `Core` отвечает за управление жизненным циклом инфраструктуры.

`Terraform Core` учитывает текущее состояние и оценивает его в соответствии с желаемой конфигурацией. Затем он предлагает план по добавлению или удалению компонентов инфраструктуры по мере необходимости. Затем он заботится о предоставлении или выводе из эксплуатации любых ресурсов, если вы решите применить план.

Плагины `Terraform` предоставляют механизм для `Terraform Core` для связи с вашим хостом инфраструктуры или поставщиками SaaS. Провайдеры и поставщики `Terraform` являются примерами плагинов, упомянутых выше. `Terraform Core` взаимодействует с плагинами через удаленный вызов процедур (RPC).
![](https://spacelift.io/_next/image?url=https%3A%2F%2Fspaceliftio.wpcomstaging.com%2Fwp-content%2Fuploads%2F2021%2F07%2Fterraform-definition.jpg&w=1920&q=75)
### Рабочий процесс Terraform
1. Пишем код | Объявите ресурсы своей инфраструктуры в виде кода на языке конфигурирования Hashicorp (HCL). 
2. Проинициализируем все providers(plugins) | Используя команду `terraform init`.
3. Создим план по обновлению инфраструктуры | Используя команду `terraform plan`.
4. Применим наш план по обновлению инфраструктуры | Используя команду `terraform apply`.

### Основные характеристики
- `Идемпотентность`: Способен привести инфраструктуру в точное состояние, определённое в конфигурационных файлах, не внося повторных изменений в уже существующие ресурсы, если это не требуется.
- `Декларативный подход`: Пользователь описывает "что" должно быть создано, а не "как" это должно быть сделано.
- `Управление состоянием`: Отслеживает текущее состояние инфраструктуры и помогает управлять её изменениями.

## Основные элементы Terraform
### Terraform CLI
Terraform CLI — это командный интерфейс для работы с Terraform. Он используется для управления инфраструктурой с помощью набора консистентных команд.

Основные команды:

- `terraform init`: Инициализирует рабочую директорию, загружая необходимые провайдеры и модули.
- `terraform plan`: Создает план выполнения, показывая, какие изменения будут внесены в инфраструктуру.
- `terraform apply`: Применяет изменения, чтобы достичь желаемого состояния конфигурации.
- `terraform destroy`: Уничтожает ресурсы, управляемые Terraform.
- `terraform fmt`: Форматирует файлы конфигурации Terraform в соответствии с рекомендациями.
- `terraform validate`: Проверяет синтаксис и корректность конфигурационных файлов.
- `terraform state`: Управляет состоянием Terraform, позволяя просматривать или изменять его.

### Terraform Language
Terraform использует язык HCL (HashiCorp Configuration Language) для описания инфраструктуры в файлах с расширением `.tf`.

Ключевые компоненты:

- Ресурсы: Представляют компоненты инфраструктуры (например, `aws_instance`, `google_compute_instance`).
- Провайдеры: Плагины, которые управляют ресурсами для конкретных платформ (например, `AWS`, `Azure`, `GCP`).
- Переменные (`Variables`): Позволяют задавать динамическую конфигурацию через блоки variable.
- Выходные данные (`Outputs`): Экспортируют информацию из `Terraform` для использования в других системах.
- Модули: Группируют ресурсы для повторного использования и упрощения управления.
- Состояние (`State`): Terraform отслеживает текущее состояние инфраструктуры в файле `.tfstate`.
### Terraform Providers
Провайдеры — это плагины, которые позволяют `Terraform` взаимодействовать с внешними платформами (например, `AWS`, `Azure`, `Kubernetes`).

Пример `aws`: Управление ресурсами `AWS`.

Особенности:

`Terraform` автоматически загружает необходимые провайдеры при выполнении команды `terraform init`.
Каждый провайдер поддерживает специфические ресурсы и имеет свои параметры конфигурации.
### Terraform Provisioners
`Provisioners` позволяют выполнять команды или скрипты на ресурсе после его создания.

Основные `Provisioners`:

- `local-exec`: Выполняет команду локально на машине, где запущен - `Terraform`.
- `remote-exec`: Выполняет команду на удаленном ресурсе через `SSH` или `WinRM`.
- `file`: Передает файлы с локальной машины на удаленный ресурс.

Пример:

```hcl
resource "aws_instance" "example" {
  ami           = "ami-123456"
  instance_type = "t2.micro"

  provisioner "remote-exec" {
    inline = [
      "sudo apt-get update",
      "sudo apt-get install -y nginx",
    ]
  }
}
```
### Terraform Modules
Модули — это повторно используемые блоки конфигурации Terraform. Они помогают организовать ресурсы и упрощают управление инфраструктурой.

Типы модулей:

- `Root Module`: Основной набор конфигурационных - файлов в рабочей директории.
- `Child Modules`: Модули, которые вызываются из основного или других модулей.

Структура модуля:

- `main.tf`: Основная конфигурация.
- `variables.tf`: Переменные для модуля.
- `outputs.tf`: Выходные данные модуля.
- `readme.md`: Документация (необязательно).

<Чуть иначе>

Модули предоставляют способ упаковки ресурсов , которые предоставляют соответствующую функциональность вместе как группа. Каждая конфигурация Terraform имеет по крайней мере один модуль, называемый корневым модулем , и может вызывать другие модули, называемые дочерними модулями. 

Легко писать модули и делиться ими с вашей командой или другими . Реестр Terraform содержит большую коллекцию модулей Terraform для часто используемых сценариев конфигурации. Terraform может автоматически загружать эти модули, если вы включите их в свою конфигурацию.
### Terraform State
Terraform хранит представление объектов вашей инфраструктуры, их взаимозависимости и привязки в файле конфигурации с именем terraform.tfstate . Хранение информации о состоянии очень помогает Terraform в принятии решений по планированию и выполнению. Состояние может храниться как локально, так и удаленно в командной среде.